<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments :: head('Pago Seguro - Barefoot Store')}"></th:block>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .pago-container {
            background: var(--color-surface);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 30px auto;
        }
        .header-pago h2 {
            color: var(--color-primary);
            font-weight: 700;
            text-align: center;
        }
        .resumen {
            background: #f5f1ed;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .resumen-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--color-primary);
        }
        .btn-pagar {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #795548 0%, #3e2723 100%) !important;
            color: white !important;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-pagar:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #8d6e63 0%, #4e342e 100%) !important;
        }

        /* Botón Yape */
        .btn-yape-container {
            background-color: #742284;
            color: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(116, 34, 132, 0.2);
        }
        .btn-yape-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(116, 34, 132, 0.4);
            color: white;
        }

        /* Estilos Inputs */
        #email {
            background-color: #ffffff !important;
            color: #212529 !important;
            border: 2px solid #ced4da !important;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .StripeElement {
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            background: white;
        }
        .StripeElement--focus { border-color: var(--color-primary); }
        .error-message { color: #dc3545; font-size: 0.9rem; margin-top: 8px; display: none; }

        .separator {
            display: flex; align-items: center; text-align: center; margin: 25px 0; color: #6c757d;
        }
        .separator::before, .separator::after { content: ''; flex: 1; border-bottom: 1px solid #dee2e6; }
        .separator span { padding: 0 10px; font-size: 0.9rem; font-weight: 500; }
    </style>
</head>
<body>

<nav th:replace="~{fragments :: navbar}"></nav>

<div class="container my-5">
    <div class="pago-container">

        <div class="header-pago mb-4">
            <h2>Elige tu Método de Pago</h2>
            <p class="text-muted">Completa tu compra de forma segura</p>
        </div>

        <div class="seccion-pago">
            <h3><i class="fas fa-box me-2"></i>Resumen de Pago</h3>
            <div class="resumen">
                <div class="resumen-item">
                    <span>Subtotal:</span>
                    <span>S/ <span th:text="${#numbers.formatDecimal(carrito.total, 1, 'COMMA', 2, 'POINT')}">0.00</span></span>
                </div>
                <div class="resumen-item">
                    <span>Envío:</span>
                    <span>S/ 15.00</span> </div>
                <div class="resumen-item">
                    <span>Total a Pagar:</span>
                    <span>S/ <span id="total-pagar" th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 2, 'POINT')}">0.00</span></span>
                </div>
            </div>
        </div>

        <div class="info-seguridad mb-4 p-3 rounded" style="background: #e8f5e9; border-left: 4px solid #4caf50; color: #2e7d32;">
            <i class="fas fa-shield-alt me-2"></i><strong>Pago 100% Seguro:</strong> Tu información está protegida.
        </div>

        <div class="seccion-pago">
            <h3><i class="fas fa-wallet me-2"></i>Forma de Pago</h3>

            <a th:href="@{/pago/yape}" class="btn-yape-container">
                <div class="d-flex align-items-center">
                    <div style="background: white; width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                        <strong style="color: #742284; font-size: 1.5rem;">Y</strong>
                    </div>
                    <div class="yape-info text-start">
                        <h5 class="m-0">Pagar con Yape</h5>
                        <small>Validación automática</small>
                    </div>
                </div>
                <i class="fas fa-chevron-right fa-lg"></i>
            </a>

            <div class="separator">
                <span>O paga con Tarjeta (Crédito/Débito)</span>
            </div>

            <form id="payment-form">
                <div class="form-group">
                    <label for="card-element">
                        <i class="fas fa-credit-card me-2"></i>Datos de la Tarjeta
                    </label>
                    <div id="card-element" class="StripeElement"></div>
                    <div id="card-errors" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope me-2"></i>Email de Confirmación
                    </label>
                    <input type="email"
                           id="email"
                           class="form-control"
                           th:value="${session.usuarioEmail}"
                           placeholder="ejemplo@correo.com"
                           required>
                </div>

                <button type="submit" class="btn-pagar" id="submit-button">
                    <span id="button-text">
                        <i class="fas fa-lock me-2"></i>PAGAR S/ <span th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 2, 'POINT')}">0.00</span>
                    </span>
                </button>
            </form>

            <div id="payment-message" style="display: none; margin-top: 20px; padding: 18px; border-radius: 10px;">
            </div>
        </div>

        <div class="text-center mt-4">
            <a th:href="@{/checkout}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Cancelar y Volver
            </a>
        </div>
    </div>
</div>

<footer th:replace="~{fragments :: footer}"></footer>
<div th:replace="~{fragments :: scripts}"></div>

<script th:inline="javascript">
    const stripe = Stripe(/*[[${stripePublicKey}]]*/ 'pk_test_xxx');
    const elements = stripe.elements();

    // Crear elemento de tarjeta
    const cardElement = elements.create('card', {
        style: {
            base: { fontSize: '16px', color: '#32325d', fontFamily: '"Helvetica Neue", Helvetica, sans-serif', '::placeholder': { color: '#aab7c4' } },
            invalid: { color: '#dc3545', iconColor: '#dc3545' }
        }
    });
    cardElement.mount('#card-element');

    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const cardErrors = document.getElementById('card-errors');
    const paymentMessage = document.getElementById('payment-message');

    // Manejar envío del formulario
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
            // Paso 1: Iniciar pago (SIN ID DE PEDIDO, SE USA SESIÓN)
            const initResponse = await fetch('/pago/api/iniciar-stripe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                // Ya no enviamos pedidoId
            });

            const initData = await initResponse.json();

            if (initData.error) {
                showError(initData.error);
                setLoading(false);
                return;
            }

            // Paso 2: Confirmar pago con Stripe
            const { paymentIntent, error } = await stripe.confirmCardPayment(
                initData.clientSecret,
                {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            email: document.getElementById('email').value
                        }
                    }
                }
            );

            if (error) {
                showError(error.message);
                setLoading(false);
            } else if (paymentIntent.status === 'succeeded') {
                // Paso 3: Confirmar en servidor (Crear Pedido)
                const confirmResponse = await fetch('/pago/api/confirmar-stripe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'paymentIntentId=' + paymentIntent.id
                });

                const confirmData = await confirmResponse.json();

                if (confirmData.exito) {
                    showSuccess('¡Pago completado! Generando pedido...');
                    setTimeout(() => {
                        window.location.href = confirmData.redirect;
                    }, 1500);
                } else {
                    showError(confirmData.error || 'Error al confirmar el pago');
                    setLoading(false);
                }
            }

        } catch (err) {
            console.error('Error:', err);
            showError('Error inesperado de conexión');
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        submitButton.disabled = isLoading;
        if (isLoading) {
            submitButton.innerHTML = '<span class="spinner"></span> Procesando...';
        } else {
            submitButton.innerHTML = '<i class="fas fa-lock me-2"></i>PAGAR S/ ' + document.getElementById('total-pagar').textContent;
        }
    }

    function showError(message) {
        paymentMessage.style.display = 'block';
        paymentMessage.style.background = '#ffebee';
        paymentMessage.style.color = '#c62828';
        paymentMessage.style.border = '1px solid #f5c6cb';
        paymentMessage.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + message;
    }

    function showSuccess(message) {
        paymentMessage.style.display = 'block';
        paymentMessage.style.background = '#e8f5e9';
        paymentMessage.style.color = '#2e7d32';
        paymentMessage.style.border = '1px solid #c3e6cb';
        paymentMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message;
    }
</script>

</body>
</html>