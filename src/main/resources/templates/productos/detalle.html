<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:insert="~{fragments :: head(title=${producto.nombre} + ' - Barefoot Store')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/detalle.css}">
</head>

<body>

<nav th:replace="~{fragments :: navbar}"></nav>

<div style="height: 100px;"></div>

<div class="container mb-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item"><a th:href="@{/inicio}">Inicio</a></li>
            <li class="breadcrumb-item"><a th:href="@{/productos}">Colección</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${producto.nombre}">Producto</li>
        </ol>
    </nav>

    <div class="product-detail-card">
        <div class="row g-0">
            <div class="col-lg-6 bg-light-texture border-end-lg">
                <div class="product-gallery h-100 d-flex align-items-center justify-content-center p-5 position-relative">

                    <div class="position-absolute top-0 start-0 m-4">
                        <span th:if="${producto.tieneDescuento()}" class="badge bg-danger rounded-0 px-3 py-2">OFERTA</span>
                    </div>

                    <img th:if="${producto.imagenUrl != null}"
                         th:src="${producto.imagenUrl}"
                         th:alt="${producto.nombre}"
                         class="img-fluid main-image shadow-sm rounded-3">

                    <div th:if="${producto.imagenUrl == null}" class="placeholder-box">
                        <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="p-5">
                    <span class="text-uppercase text-accent ls-2 small fw-bold" th:text="${producto.categoria}">Categoría</span>
                    <h1 class="font-serif fw-bold text-primary-dark mt-2 mb-3" th:text="${producto.nombre}">Nombre</h1>

                    <div class="price-area mb-4 border-bottom pb-4 border-light-brown">
                        <div class="d-flex align-items-baseline gap-3">
                            <span class="display-6 fw-bold text-primary" th:text="'S/ ' + ${producto.precioFinal}">S/ 0.00</span>
                            <span th:if="${producto.tieneDescuento()}" class="text-muted text-decoration-line-through fs-5" th:text="'S/ ' + ${producto.precio}"></span>
                        </div>
                        <div class="stock-status mt-2">
                            <span th:if="${producto.stock > 10}" class="text-success small"><i class="fas fa-circle fa-xs me-1"></i> Disponible</span>
                            <span th:if="${producto.stock <= 10 && producto.stock > 0}" class="text-warning small"><i class="fas fa-exclamation-circle me-1"></i> Pocas unidades</span>
                            <span th:if="${producto.stock == 0}" class="text-danger small"><i class="fas fa-times-circle me-1"></i> Agotado</span>
                        </div>
                    </div>

                    <p class="text-muted leading-relaxed mb-4" th:text="${producto.descripcion}">
                        Descripción...
                    </p>

                    <div class="features-grid row g-3 mb-4">
                        <div class="col-6" th:if="${producto.material != null}">
                            <div class="d-flex align-items-center">
                                <div class="icon-square me-3"><i class="fas fa-layer-group"></i></div>
                                <div>
                                    <span class="d-block small text-uppercase fw-bold text-muted">Material</span>
                                    <span th:text="${producto.material}">Cuero</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-start"> <div class="icon-square me-3 mt-1"><i class="fas fa-ruler"></i></div>
                                <div class="w-100">
                                    <label for="talla-select" class="d-block small text-uppercase fw-bold text-muted mb-1">
                                        Talla
                                    </label>
                                    <select id="talla-select" class="form-select form-select-elegant">
                                        <option value="" selected disabled>Seleccionar...</option>
                                        <th:block th:each="i : ${#numbers.sequence(35, 45)}">
                                            <option th:value="${i}" th:text="${i}"></option>
                                        </th:block>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="purchase-actions mt-5" th:if="${producto.stock > 0}">
                        <div class="d-flex gap-3 align-items-stretch">
                            <div class="quantity-input d-flex border rounded border-light-brown">
                                <button onclick="decreaseQuantity()" class="btn btn-link text-dark px-3 text-decoration-none">-</button>
                                <input type="number" id="quantity" value="1" min="1" th:max="${producto.stock}" class="form-control border-0 text-center fw-bold" style="width: 50px;">
                                <button onclick="increaseQuantity()" class="btn btn-link text-dark px-3 text-decoration-none">+</button>
                            </div>

                            <button class="btn btn-primary-elegant flex-grow-1" onclick="addToCart()">
                                Añadir al Carrito
                            </button>

                            <a th:href="@{/favoritos/toggle/{id}(id=${producto.id})}"
                               class="btn btn-outline-elegant px-3 d-flex align-items-center"
                               th:title="${favoritosIds != null && #lists.contains(favoritosIds, producto.id)} ? 'Quitar' : 'Guardar'">
                                <i class="fa-heart" th:classappend="${favoritosIds != null && #lists.contains(favoritosIds, producto.id)} ? 'fas text-danger' : 'far'"></i>
                            </a>
                        </div>
                    </div>

                    <div th:if="${producto.stock == 0}" class="alert alert-light border-danger text-danger mt-4">
                        Este producto no está disponible por el momento.
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-5 border-top border-light-brown" th:if="${!#lists.isEmpty(productosRelacionados)}">
        <h3 class="font-serif fw-bold mb-4 text-center">También te podría gustar</h3>
        <div class="row g-4">
            <div class="col-md-3" th:each="relacionado, stat : ${productosRelacionados}" th:if="${stat.index < 4}">
                <div class="product-card-mini">
                    <a th:href="@{/productos/{id}(id=${relacionado.id})}">
                        <div class="img-wrapper rounded-3 overflow-hidden mb-3 border border-light-brown">
                            <img th:if="${relacionado.imagenUrl != null}" th:src="${relacionado.imagenUrl}" class="img-fluid w-100">
                            <div th:if="${relacionado.imagenUrl == null}" class="bg-light p-5 text-center"><i class="fas fa-image"></i></div>
                        </div>
                        <h6 class="text-dark fw-bold mb-1" th:text="${relacionado.nombre}">Producto</h6>
                        <span class="text-primary" th:text="'S/ ' + ${relacionado.precioFinal}">S/ 0.00</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<footer th:replace="~{fragments :: footer}"></footer>
<div th:replace="~{fragments :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const maxStock = /*[[${producto.stock}]]*/ 1;
    const productoId = /*[[${producto.id}]]*/ 0;

    function increaseQuantity() {
        const input = document.getElementById('quantity');
        const currentValue = parseInt(input.value);
        if (currentValue < maxStock) input.value = currentValue + 1;
    }

    function decreaseQuantity() {
        const input = document.getElementById('quantity');
        const currentValue = parseInt(input.value);
        if (currentValue > 1) input.value = currentValue - 1;
    }

    function addToCart() {
        const quantity = document.getElementById('quantity').value;
        const tallaSelect = document.getElementById('talla-select');

        // 1. VALIDACIÓN: Asegurar que se haya elegido una talla
        if (!tallaSelect || tallaSelect.value === "") {
            alert("Por favor, selecciona una talla antes de agregar al carrito.");
            tallaSelect.focus(); // Enfocar el selector para ayudar al usuario
            return;
        }

        const tallaSeleccionada = tallaSelect.value;

        // 2. CREAR EL FORMULARIO
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/carrito/agregar';

        // Input ID Producto
        const pInput = document.createElement('input');
        pInput.type = 'hidden';
        pInput.name = 'productoId';
        pInput.value = productoId;
        form.appendChild(pInput);

        // Input Cantidad
        const qInput = document.createElement('input');
        qInput.type = 'hidden';
        qInput.name = 'cantidad';
        qInput.value = quantity;
        form.appendChild(qInput);

        // 3. NUEVO: Input Personalización (Para guardar la talla)
        // Usamos el campo 'personalizacion' que ya existe en tu controlador
        const persInput = document.createElement('input');
        persInput.type = 'hidden';
        persInput.name = 'personalizacion';
        persInput.value = 'Talla: ' + tallaSeleccionada;
        form.appendChild(persInput);

        document.body.appendChild(form);
        form.submit();
    }
    /*]]>*/
</script>

</body>
</html>