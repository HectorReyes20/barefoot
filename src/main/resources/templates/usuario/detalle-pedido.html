<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments :: head('Detalle Pedido - Barefoot Store')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/usuario.css}">
</head>
<body>

<nav th:replace="~{fragments :: navbar}"></nav>

<div style="height: 100px;"></div>

<div class="container mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <span class="text-muted small text-uppercase fw-bold">Pedido</span>
            <h2 class="font-serif fw-bold text-primary-dark m-0" th:text="${pedido.numeroPedido}">PED-001</h2>
        </div>
        <a th:href="@{/mis-pedidos}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Volver
        </a>
    </div>

    <div th:if="${transaccion != null && transaccion.estado.name() == 'PENDIENTE' && pedido.estado.name() != 'CANCELADO'}"
         class="alert alert-warning mb-4 shadow-sm border-warning">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong><i class="fas fa-exclamation-triangle me-2"></i> Pago Pendiente</strong>
                <p class="mb-0 small">Este pedido requiere confirmación de pago.</p>
            </div>
            <a th:href="@{/pago/manual/{id}(id=${pedido.id})}" class="btn btn-warning btn-sm fw-bold">
                Pagar Ahora
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card-elegant mb-4">
                <div class="card-header-elegant">
                    <h5>Productos</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-elegant mb-0">
                        <tbody>
                        <tr th:each="detalle : ${pedido.detalles}">
                            <td style="width: 80px;">
                                <img th:if="${detalle.producto.imagenUrl != null}"
                                     th:src="${detalle.producto.imagenUrl}"
                                     class="rounded" style="width: 60px; height: 60px; object-fit: cover;">
                                <div th:if="${detalle.producto.imagenUrl == null}"
                                     class="bg-light rounded d-flex align-items-center justify-content-center"
                                     style="width: 60px; height: 60px;"><i class="fas fa-image text-muted"></i></div>
                            </td>
                            <td>
                                <strong th:text="${detalle.producto.nombre}" class="d-block text-dark">Producto</strong>
                                <small th:if="${detalle.personalizacion != null}" class="text-muted fst-italic">
                                    <i class="fas fa-palette me-1 text-accent"></i> <span th:text="${detalle.personalizacion}"></span>
                                </small>
                            </td>
                            <td class="text-center">x<span th:text="${detalle.cantidad}">1</span></td>
                            <td class="text-end fw-bold">S/ <span th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 'COMMA', 2, 'POINT')}"></span></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-elegant">
                <div class="card-header-elegant">
                    <h5>Información de Envío</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="small text-muted fw-bold d-block">Dirección</label>
                            <span th:text="${pedido.direccionEnvio}">Calle 123</span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="small text-muted fw-bold d-block">Método de Pago</label>
                            <span th:text="${pedido.metodoPago != null ? pedido.metodoPago.nombre : '-'}">Tarjeta</span>
                        </div>
                        <div class="col-12" th:if="${pedido.notas != null}">
                            <label class="small text-muted fw-bold d-block">Notas</label>
                            <p class="mb-0 fst-italic text-muted" th:text="${pedido.notas}"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-elegant sticky-top" style="top: 120px;">
                <div class="card-header-elegant">
                    <h5>Resumen</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal</span>
                        <span>S/ <span th:text="${#numbers.formatDecimal(pedido.subtotal, 1, 'COMMA', 2, 'POINT')}"></span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                        <span class="text-muted">Envío</span>
                        <span th:if="${pedido.costoEnvio == 0}" class="text-success fw-bold">GRATIS</span>
                        <span th:if="${pedido.costoEnvio > 0}">S/ <span th:text="${#numbers.formatDecimal(pedido.costoEnvio, 1, 'COMMA', 2, 'POINT')}"></span></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fs-5 fw-bold text-primary">Total</span>
                        <span class="fs-4 fw-bold text-primary">S/ <span th:text="${#numbers.formatDecimal(pedido.total, 1, 'COMMA', 2, 'POINT')}"></span></span>
                    </div>

                    <div class="mt-4 pt-3 border-top">
                        <label class="small text-muted fw-bold d-block mb-2">Estado del Pedido</label>
                        <span th:class="'badge-status badge-' + ${pedido.estado}"
                              style="font-size: 1rem; display: block; text-align: center;"
                              th:text="${pedido.estado.nombre}">PENDIENTE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments :: footer}"></footer>
<div th:replace="~{fragments :: scripts}"></div>
</body>
</html>