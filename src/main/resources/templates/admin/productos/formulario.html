<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <head th:replace="~{admin/layout/head :: head(titulo=(${esEdicion} ? 'Editar Producto' : 'Nuevo Producto') + ' - Barefoot Admin')}"></head>

  <link th:href="@{/css/form-producto.css}" rel="stylesheet">
</head>
<body>

<div th:replace="~{admin/layout/sidebar :: sidebar(paginaActiva='productos')}"></div>

<div class="main-content">

  <div th:replace="~{admin/layout/navbar :: navbar(tituloPagina=(${esEdicion} ? 'Editar Producto' : 'Nuevo Producto'), iconoPagina='fas fa-box')}"></div>

  <div class="form-card">
    <form th:action="${esEdicion} ? @{/admin/productos/actualizar/{id}(id=${producto.id})} : @{/admin/productos/guardar}"
          method="post"
          th:object="${producto}">

      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-info-circle me-2"></i> Información Básica
        </h4>

        <div class="row">
          <div class="col-md-8">
            <div class="mb-3">
              <label for="nombre" class="form-label">
                <i class="fas fa-tag me-1"></i> Nombre del Producto *
              </label>
              <input type="text" class="form-control" id="nombre"
                     th:field="*{nombre}" placeholder="Ej: Urban Barefoot Negro" required>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="categoria" class="form-label">
                <i class="fas fa-folder me-1"></i> Categoría *
              </label>
              <select class="form-select" id="categoria" th:field="*{categoria}" required>
                <option value="">Seleccionar...</option>
                <option value="Casual">Casual</option>
                <option value="Deportivo">Deportivo</option>
                <option value="Formal">Formal</option>
                <option value="Infantil">Infantil</option>
                <option value="Running">Running</option>
                <option value="Senderismo">Senderismo</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="descripcion" class="form-label">
            <i class="fas fa-align-left me-1"></i> Descripción
          </label>
          <textarea class="form-control" id="descripcion"
                    th:field="*{descripcion}" rows="3"
                    placeholder="Describe las características del producto..."></textarea>
        </div>
      </div>

      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-dollar-sign me-2"></i> Precios y Stock
        </h4>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label for="precio" class="form-label">
                <i class="fas fa-money-bill-wave me-1"></i> Precio (S/) *
              </label>
              <input type="number" class="form-control" id="precio"
                     th:field="*{precio}" step="0.01" min="0" placeholder="299.00" required>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="precioDescuento" class="form-label">
                <i class="fas fa-tag me-1"></i> Precio con Descuento (S/)
              </label>
              <input type="number" class="form-control" id="precioDescuento"
                     th:field="*{precioDescuento}" step="0.01" min="0" placeholder="249.00">
              <small class="text-muted">Dejar vacío si no hay descuento</small>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="stock" class="form-label">
                <i class="fas fa-boxes me-1"></i> Stock *
              </label>
              <input type="number" class="form-control" id="stock"
                     th:field="*{stock}" min="0" placeholder="50" required>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-list me-2"></i> Características
        </h4>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label for="talla" class="form-label">
                <i class="fas fa-ruler me-1"></i> Talla
              </label>
              <select class="form-select" id="talla" th:field="*{talla}">
                <option value="">Seleccionar...</option>
                <option value="35">35</option>
                <option value="36">36</option>
                <option value="37">37</option>
                <option value="38">38</option>
                <option value="39">39</option>
                <option value="40">40</option>
                <option value="41">41</option>
                <option value="42">42</option>
                <option value="43">43</option>
                <option value="44">44</option>
                <option value="45">45</option>
              </select>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="color" class="form-label">
                <i class="fas fa-palette me-1"></i> Color
              </label>
              <select class="form-select" id="color" th:field="*{color}">
                <option value="">Seleccionar...</option>
                <option value="Negro">Negro</option>
                <option value="Blanco">Blanco</option>
                <option value="Marrón">Marrón</option>
                <option value="Beige">Beige</option>
                <option value="Gris">Gris</option>
                <option value="Azul">Azul</option>
                <option value="Verde">Verde</option>
                <option value="Rojo">Rojo</option>
              </select>
            </div>
          </div>

          <div class="col-md-4">
            <div class="mb-3">
              <label for="material" class="form-label">
                <i class="fas fa-layer-group me-1"></i> Material
              </label>
              <select class="form-select" id="material" th:field="*{material}">
                <option value="">Seleccionar...</option>
                <option value="Cuero">Cuero</option>
                <option value="Lona">Lona</option>
                <option value="Sintético">Sintético</option>
                <option value="Malla">Malla</option>
                <option value="Gamuza">Gamuza</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-image me-2"></i> Imagen del Producto
        </h4>

        <div class="mb-3">
          <label for="imagenUrl" class="form-label">
            <i class="fas fa-link me-1"></i> URL de la Imagen
          </label>
          <input type="url" class="form-control" id="imagenUrl"
                 th:field="*{imagenUrl}"
                 placeholder="https://ejemplo.com/imagen.jpg"
                 onchange="previewImage(this.value)">
          <small class="text-muted">Pega la URL de una imagen desde internet</small>
        </div>

        <div id="imagePreview" th:if="${producto.imagenUrl != null}">
          <img th:src="${producto.imagenUrl}" class="imagen-preview" alt="Preview">
        </div>
      </div>

      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-toggle-on me-2"></i> Estado del Producto
        </h4>

        <div class="row">
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="activo"
                     th:field="*{activo}">
              <label class="form-check-label" for="activo">
                <i class="fas fa-check-circle me-1"></i> Producto Activo
              </label>
              <small class="d-block text-muted">El producto será visible en la tienda</small>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="destacado"
                     th:field="*{destacado}">
              <label class="form-check-label" for="destacado">
                <i class="fas fa-star me-1"></i> Producto Destacado
              </label>
              <small class="d-block text-muted">Aparecerá en la sección destacados</small>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-3 justify-content-end">
        <a th:href="@{/admin/productos}" class="btn btn-cancelar">
          <i class="fas fa-times me-2"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-guardar">
          <i class="fas fa-save me-2"></i>
          <span th:text="${esEdicion} ? 'Actualizar Producto' : 'Guardar Producto'">Guardar</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Preview de imagen
  function previewImage(url) {
      const previewDiv = document.getElementById('imagePreview');

      if (!previewDiv) {
          const container = document.createElement('div');
          container.id = 'imagePreview';
          document.getElementById('imagenUrl').parentElement.appendChild(container);
      }

      if (url && url.trim() !== '') {
          document.getElementById('imagePreview').innerHTML =
              '<img src="' + url + '" class="imagen-preview" alt="Preview" onerror="this.style.display=\'none\'">';
      } else {
          document.getElementById('imagePreview').innerHTML = '';
      }
  }

  // Calcular porcentaje de descuento automáticamente
  document.getElementById('precio').addEventListener('input', calcularDescuento);
  document.getElementById('precioDescuento').addEventListener('input', calcularDescuento);

  function calcularDescuento() {
      const precio = parseFloat(document.getElementById('precio').value);
      const precioDescuento = parseFloat(document.getElementById('precioDescuento').value);

      if (precio && precioDescuento && precioDescuento < precio) {
          const porcentaje = ((precio - precioDescuento) / precio * 100).toFixed(0);
          document.getElementById('precioDescuento').nextElementSibling.textContent =
              'Descuento del ' + porcentaje + '%';
          document.getElementById('precioDescuento').nextElementSibling.classList.add('text-success');
      } else {
          document.getElementById('precioDescuento').nextElementSibling.textContent =
              'Dejar vacío si no hay descuento';
          document.getElementById('precioDescuento').nextElementSibling.classList.remove('text-success');
      }
  }

  // Validación del formulario
  document.querySelector('form').addEventListener('submit', function (e) {
      const precio = parseFloat(document.getElementById('precio').value);
      const precioDescuento = parseFloat(document.getElementById('precioDescuento').value);

      if (precioDescuento && precioDescuento >= precio) {
          e.preventDefault();
          alert('El precio con descuento debe ser menor al precio regular');
          return false;
      }

      const stock = parseInt(document.getElementById('stock').value);
      if (stock < 0) {
          e.preventDefault();
          alert('El stock no puede ser negativo');
          return false;
      }
  });

  // Calcular descuento al cargar si ya existe
  window.addEventListener('load', calcularDescuento);
</script>
</body>
</html>