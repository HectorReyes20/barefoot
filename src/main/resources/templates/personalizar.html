<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{fragments :: head('Personaliza tu Calzado - Barefoot Store')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/personalizar.css}">
    <style>
        /* Estilos básicos (puedes moverlos a personalizar.css) */
        :root {
            --color-primary: #4E342E;
            --color-accent: #F39C12;
            --color-background: #FBF9F6;
            --color-surface: #FFFFFF;
            --color-text: #3E3E3E;
        }
        /* ... (Mismos estilos que antes) ... */
        .personalizador-container { background-color: var(--color-surface); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .opcion-personalizacion { margin-bottom: 30px; }
        .opcion-personalizacion label { font-weight: 600; color: var(--color-primary); margin-bottom: 10px; display: block; }
        .color-selector button, .material-selector button { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #eee; margin-right: 10px; cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .color-selector button:hover, .material-selector button:hover { transform: scale(1.1); }
        .color-selector button.active, .material-selector button.active { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.5); }
        .material-selector button { border-radius: 8px; background-size: cover; font-size: 0.7rem; color: white; text-shadow: 1px 1px 2px black; }
        .vista-previa { background-color: var(--color-background); border-radius: 15px; padding: 30px; text-align: center; position: sticky; top: 100px; }
        #svg-preview-container { width: 100%; max-width: 400px; margin: 0 auto 20px auto; border: 1px solid #ddd; border-radius: 10px; background-color: #f8f8f8; padding: 10px; }
        #svg-preview-container svg { width: 100%; height: auto; display: block; }
        #svg-shoe path, #svg-shoe g path { transition: fill 0.3s ease, stroke 0.3s ease; }
        .resumen { margin-top: 20px; text-align: left; }
        .resumen p { margin-bottom: 5px; }
        .btn-agregar-carrito { background: linear-gradient(135deg, var(--color-primary), var(--color-accent)); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: 600; width: 100%; margin-top: 20px; transition: all 0.3s; }
        .btn-agregar-carrito:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(78, 52, 46, 0.3); }
    </style>
</head>
<body>

<nav th:replace="~{fragments :: navbar}"></nav>

<div class="container my-5">
    <div class="text-center mb-5">
        <h1><i class="fas fa-palette me-2"></i> Personaliza tu Calzado Barefoot</h1>
        <p class="lead text-muted">Crea un diseño único que refleje tu estilo y necesidades.</p>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="personalizador-container">

                <div class="opcion-personalizacion">
                    <label for="modeloBase"><i class="fas fa-shoe-prints me-2"></i>1. Elige tu Modelo Base</label>
                    <select id="modeloBase" class="form-select form-select-lg">
                        <option value="urban" data-precio="299">Urban Barefoot (S/ 299)</option>
                        <option value="sport" data-precio="349">Sport Flex (S/ 349)</option>
                        <option value="classic" data-precio="399">Classic Barefoot (S/ 399)</option>
                    </select>
                </div>

                <div class="opcion-personalizacion">
                    <label><i class="fas fa-fill-drip me-2"></i>2. Color Principal (Cuerpo)</label>
                    <div class="color-selector" id="colorBaseSelector">

                        <button type="button" data-color="#4E342E" style="background-color: #4E342E;" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                        <button type="button" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;" class="active" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                        <button type="button" data-color="#000000" style="background-color: #000000;" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                        <button type="button" data-color="#1565C0" style="background-color: #1565C0;" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                        <button type="button" data-color="#2E7D32" style="background-color: #2E7D32;" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                        <button type="button" data-color="#C62828" style="background-color: #C62828;" onclick="seleccionarOpcion(this, 'colorBase', 'cuerpo')"></button>
                    </div>
                </div>

                <div class="opcion-personalizacion">
                    <label><i class="fas fa-shoe-prints me-2"></i>3. Color de la Suela</label>
                    <div class="color-selector" id="colorSuelaSelector">

                        <button type="button" data-color="#BFBFBF" style="background-color: #BFBFBF;" class="active" onclick="seleccionarOpcion(this, 'colorSuela', 'suela')"></button>
                        <button type="button" data-color="#555555" style="background-color: #555555;" onclick="seleccionarOpcion(this, 'colorSuela', 'suela')"></button>
                        <button type="button" data-color="#000000" style="background-color: #000000;" onclick="seleccionarOpcion(this, 'colorSuela', 'suela')"></button>
                        <button type="button" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;" onclick="seleccionarOpcion(this, 'colorSuela', 'suela')"></button>
                        <button type="button" data-color="#C0A080" style="background-color: #C0A080;" onclick="seleccionarOpcion(this, 'colorSuela', 'suela')"></button>
                    </div>
                </div>

                <div class="opcion-personalizacion">
                    <label><i class="fas fa-grip-lines me-2"></i>4. Color de los Cordones</label>
                    <div class="color-selector" id="colorCordonesSelector">

                        <button type="button" data-color="#000000" style="background-color: #000000;" class="active" onclick="seleccionarOpcion(this, 'colorCordones', 'cordones')"></button>
                        <button type="button" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;" onclick="seleccionarOpcion(this, 'colorCordones', 'cordones')"></button>
                        <button type="button" data-color="#F39C12" style="background-color: #F39C12;" onclick="seleccionarOpcion(this, 'colorCordones', 'cordones')"></button>
                        <button type="button" data-color="#4E342E" style="background-color: #4E342E;" onclick="seleccionarOpcion(this, 'colorCordones', 'cordones')"></button>
                        <button type="button" data-color="#C62828" style="background-color: #C62828;" onclick="seleccionarOpcion(this, 'colorCordones', 'cordones')"></button>
                    </div>
                </div>

                <div class="opcion-personalizacion">
                    <label><i class="fas fa-layer-group me-2"></i>5. Material Principal</label>
                    <div class="material-selector" id="materialSelector">
                        <button type="button" data-material="Cuero" class="active" style="background-color: #8B4513;" onclick="seleccionarOpcion(this, 'material')">Cuero</button>
                        <button type="button" data-material="Lona" style="background-color: #D2B48C;" onclick="seleccionarOpcion(this, 'material')">Lona</button>
                        <button type="button" data-material="Malla" style="background-color: #A9A9A9;" onclick="seleccionarOpcion(this, 'material')">Malla</button>
                        <button type="button" data-material="Gamuza" style="background-color: #DEB887;" onclick="seleccionarOpcion(this, 'material')">Gamuza</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="vista-previa">
                <h4><i class="fas fa-eye me-2"></i> Tu Diseño</h4>
                <div id="svg-preview-container">
                    {/* */}
                    <svg id="svg-shoe" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 474.32 222.77">
                        <defs> <linearGradient id="d" x1=".2605" x2=".62185" y1=".90625" y2=".4375"> <stop offset="0"/> <stop stop-opacity="0" offset="1"/> </linearGradient> <linearGradient id="c" x1=".64084" x2=".44718" y1=".81" y2=".03"> <stop stop-color="#fff" offset="0"/> <stop stop-color="#fff" stop-opacity="0" offset="1"/> </linearGradient> </defs>
                        <g fill-rule="evenodd">
                            <path d="m309.05 120.53s-175.07-59.18-175.07-70.276 4.932-4.9317 6.165-17.261c-19.727-23.425 0-24.658 13.562-32.056 8.63 20.96 56.714 40.686 56.714 40.686l109.73 60.413-11.096 18.494z" fill="#ccc" stroke="#000" stroke-width="1.877"/> <path d="m132.74 49.022s6.1645 4.9316 9.8633-4.9316c3.6987-9.8633-6.1646-29.59-1.2329-22.192 4.9316 7.3975 143.02 80.139 143.02 80.139l-151.65-53.015z" fill="url(#d)"/>
                            <g stroke="#000" stroke-width="1.877">
                                <path d="m31.176 26.83c3.6987-7.3975 27.124-14.795 32.056-9.8633 4.9316 4.9316 11.096 20.96 18.494 25.891 7.3975 4.9316 30.823 13.562 38.22 9.8633 7.3975-3.6988 29.59-14.795 30.823-7.3975 1.2329 7.3975 7.3974 50.549-25.891 50.549-33.289 0-69.043 12.329-78.906-7.3975-9.8633-19.727-14.795-61.646-14.795-61.646z" fill="#999"/>
                                <path id="svg-parte-cuerpo" d="m2.9837 138.02s-1.2329-61.646 3.6987-72.742 14.795-33.289 19.726-38.22c4.9316-4.9316 8.6304-6.1646 13.562 0 4.9316 6.1645 4.9316 28.357 11.096 36.987 6.1645 8.6304 9.8633 14.795 22.192 16.028 12.329 1.2329 25.891-4.9316 36.987-14.795 11.096-9.8633 18.494-22.192 27.124-24.658 8.6304-2.4658 9.8633 0 24.658 8.6304s136.85 54.248 136.85 54.248l12.329-1.2329-125.76-73.975s101.1 54.248 119.59 64.111c18.494 9.8633 28.357 19.727 38.22 20.96 9.8633 1.2329 39.453-6.1646 48.084-1.2329 8.6304 4.9317 17.261 7.3974 20.96 17.261 3.6987 9.8633 7.3975 43.152 7.3975 43.152s-14.795 19.726-33.289 24.658c-18.494 4.9316-108.5 24.658-130.69 20.96-22.192-3.6987-57.947-3.6987-72.742-12.329-14.795-8.6304-41.919-9.8633-55.481-9.8633s-73.975 4.9316-90.002-2.4658c-16.028-7.3974-25.891-35.754-30.823-40.686-4.9316-4.9316-3.6987-14.795-3.6987-14.795z" fill="#FFFFFF"/>
                            </g>
                            <path d="m10.076 129.43c-2.7268-6.817-2.7268 38.176-1.3634 40.903 141.8 27.269 224.97 9.544 224.97 9.544s-104.98 9.544-211.33-24.542c-9.544-8.181-12.271-25.905-12.271-25.905z" fill-opacity=".227"/>
                            <g stroke="#000">
                                <path id="svg-parte-suela" d="m0.5179 140.09-3.6987 30.067s0 1.879 1.2329 8.456 2.4658 10.336 9.8633 13.154c7.3974 2.819 76.44 13.155 80.139 13.155 3.6987 0 32.056-7.517 46.85-5.638 14.795 1.879 24.658 3.758 32.056 6.577 7.397 2.819 23.425 11.275 54.248 12.215 30.822 0.93901 64.111 2.819 99.865-4.698 35.755-7.517 70.276-16.913 82.605-20.671s25.891-13.154 27.124-19.732c1.233-6.577 3.699-16.912-2.465-24.429-6.165-7.517-13.562-17.852-13.562-10.336 0 7.517-13.562 6.578-14.795 13.155s1.233 15.033 1.233 15.973c6.164-1.879-8.631 7.517-30.823 9.396-22.193 1.879-38.22 12.215-61.646 9.396-23.425-2.819-70.276-10.336-80.139-10.336s-92.468 5.638-118.36 2.819c-25.891-2.819-82.605-12.215-94.934-16.913s-14.795-21.61-14.795-21.61h-1e-5z" fill="#BFBFBF" stroke-width="1.638"/>
                                <path d="m313.98 97.105-19.726 13.562-19.727-34.522-50.549 4.9316-3.6987-35.754-55.481 9.8633 12.329-19.727 23.425-1.2329v35.754l42.238-11.618 21.873 38.742h49.316z" fill="#ccc" stroke-linecap="round" stroke-linejoin="round" stroke-width="5.63"/>
                            </g>
                            <path d="m320.61 108.67s9.8632 4.9316 20.959 6.1645 43.152-2.4658 43.152-2.4658 13.562 0 1.2329 7.3975c-12.329 7.3974-106.03 29.59-92.468 22.192 13.562-7.3975 48.084-11.096 57.947-17.261 9.8633-6.1646-30.823-16.028-30.823-16.028z" fill="url(#c)"/> <path d="m34.338 33.932s2.6253-9.8633 5.369-2.4658c2.7437 7.3974 5.8328 25.891 11.404 33.288 3.7855 6.3119 23.136 28.543 7.4299 16.617-25.769-27.124-24.203-47.44-24.203-47.44z" fill="#fff" fill-opacity=".616"/> <path d="m203.02 79.845s108.5 34.522 92.468 41.919c-16.028 7.3974-92.468-41.919-92.468-41.919z" fill-opacity=".054"/>

                            <g id="svg-parte-cordones" fill="none" stroke="#000000" stroke-width="5.63">
                                <g stroke-linecap="round" stroke-linejoin="round">

                                    <path d="m175.89 35.46c-11.096-3.6987-7.3974-3.6987-17.261-1.2329-9.8632 2.4658-19.727 14.795-8.6304 16.028 11.096 1.2329 19.727-3.6987 25.891-14.795z"/>
                                    <path d="m174.66 31.761s4.9317-11.096 13.562-9.8633c8.6304 1.2329 20.96 9.8633 11.096 6.1646-8.6304 6.1645-24.658 3.6987-24.658 3.6987z"/>
                                </g>
                                <path d="m186.99 62.584-11.096-28.357s23.425 12.329 30.823 18.494"/>
                            </g>
                        </g>
                        <g font-family="Arial" font-size="24" stroke-width="0" text-anchor="middle"> <text transform="matrix(4.5 0 0 2.3214 -164.5 -125.54)" x="53.6843" y="116.887"/> <text transform="matrix(8.7333 0 0 1.5 -1020.8 -32.5)" x="139.684" y="86.8874" stroke-dasharray="null" stroke-linejoin="round"/> </g>
                    </svg>
                </div>

                <div class="resumen">
                    <h5>Resumen:</h5>
                    <p><strong>Modelo:</strong> <span id="resumenModelo">Urban Barefoot</span></p>
                    <p><strong>Color Principal:</strong> <span id="resumenColorBase">Blanco (#FFFFFF)</span></p>
                    <p><strong>Color Suela:</strong> <span id="resumenColorSuela">Gris (#BFBFBF)</span></p>
                    <p><strong>Color Cordones:</strong> <span id="resumenColorCordones">Negro (#000000)</span></p>
                    <p><strong>Material:</strong> <span id="resumenMaterial">Cuero</span></p>
                    <hr>
                    <p class="h4"><strong>Precio Total: S/ <span id="precioTotal">299.00</span></strong></p>
                </div>
                <button class="btn btn-agregar-carrito" onclick="agregarAlCarrito()">
                    <i class="fas fa-shopping-cart me-2"></i> Agregar al Carrito
                </button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments :: footer}"></footer>
<div th:replace="~{fragments :: scripts}"></div>

<script>
    const configuracion = {
        modelo: 'urban',
        precioBase: 299,
        colorBase: '#FFFFFF',
        colorSuela: '#BFBFBF',
        colorCordones: '#000000',
        material: 'Cuero'
    };

    // DOM Elements
    const modeloSelect = document.getElementById('modeloBase');
    const precioTotalEl = document.getElementById('precioTotal');
    const resumenModeloEl = document.getElementById('resumenModelo');
    const resumenColorBaseEl = document.getElementById('resumenColorBase');
    const resumenColorSuelaEl = document.getElementById('resumenColorSuela');
    const resumenColorCordonesEl = document.getElementById('resumenColorCordones');
    const resumenMaterialEl = document.getElementById('resumenMaterial');

    // SVG Element ID Map
    const svgIdMap = {
        cuerpo: 'svg-parte-cuerpo',
        suela: 'svg-parte-suela',
        cordones: 'svg-parte-cordones' // The <g> element for laces
    };

    // --- Event Listeners ---
    modeloSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        configuracion.modelo = this.value;
        configuracion.precioBase = parseFloat(selectedOption.getAttribute('data-precio'));
        resumenModeloEl.textContent = selectedOption.text.split(' (')[0];
        actualizarPrecio();
    });

    // --- Functions ---
    function seleccionarOpcion(botonSeleccionado, tipoConfig, svgPartKey = null) {
        const esMaterial = tipoConfig === 'material';
        const valor = botonSeleccionado.getAttribute(esMaterial ? 'data-material' : 'data-color');

        configuracion[tipoConfig] = valor;

        // Update active button
        const selectorContainer = botonSeleccionado.parentElement;
        selectorContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        botonSeleccionado.classList.add('active');

        // Update summary text
        const resumenElementId = `resumen${tipoConfig.charAt(0).toUpperCase() + tipoConfig.slice(1)}`;
        document.getElementById(resumenElementId).textContent = esMaterial ? valor : `${valor} (${valor})`;

        // Update SVG if applicable
        if (!esMaterial && svgPartKey) {
            cambiarColorSVG(svgPartKey, valor);
        }

        actualizarPrecio();
    }

    // *** CORRECTED SVG COLOR CHANGE FUNCTION ***
    function cambiarColorSVG(partKey, color) {
        const elementId = svgIdMap[partKey];
        if (!elementId) {
             console.error(`SVG part key "${partKey}" not found in svgIdMap.`);
             return;
        }
        const parte = document.getElementById(elementId);
        if (parte) {
            if (partKey === 'cordones') {
                // Apply stroke color to all PATH elements within the 'cordones' group
                const lacePaths = parte.querySelectorAll('path');
                if (lacePaths.length > 0) {
                    lacePaths.forEach(p => {
                        p.setAttribute('stroke', color);
                        // Make sure fill is 'none' so stroke is clearly visible
                        p.setAttribute('fill', 'none');
                    });
                } else {
                    // Fallback or warning if no paths found inside
                    console.warn(`No <path> elements found within #${elementId}`);
                    // Setting stroke on the group itself might work sometimes, but less reliable
                    // parte.setAttribute('stroke', color);
                }
            } else {
                // For other parts (body, sole), set the fill color
                 parte.setAttribute('fill', color);
            }
        } else {
            console.warn(`SVG element with ID "${elementId}" (key "${partKey}") not found.`);
        }
    }

    function actualizarPrecio() {
        let precioFinal = configuracion.precioBase;
        // Add extra costs for materials if needed
        // if (configuracion.material === 'Gamuza') { precioFinal += 20; }
        precioTotalEl.textContent = precioFinal.toFixed(2);
    }

    function agregarAlCarrito() {
        // Placeholder alert
        alert(`Producto Personalizado agregado:\n
            Modelo: ${configuracion.modelo}\n
            Color Base: ${configuracion.colorBase}\n
            Color Suela: ${configuracion.colorSuela}\n
            Color Cordones: ${configuracion.colorCordones}\n
            Material: ${configuracion.material}\n
            Precio: S/ ${precioTotalEl.textContent}\n
            (Funcionalidad completa en Sprint 4)`);
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Apply initial colors to SVG
        cambiarColorSVG('cuerpo', configuracion.colorBase);
        cambiarColorSVG('suela', configuracion.colorSuela);
        cambiarColorSVG('cordones', configuracion.colorCordones);
        actualizarPrecio();

        // Set initial active buttons and summary text
        try {
            // Remove any default 'active' class first before setting the correct one
            document.querySelectorAll('.color-selector button.active, .material-selector button.active').forEach(btn => btn.classList.remove('active'));

            document.querySelector(`#colorBaseSelector button[data-color="${configuracion.colorBase}"]`)?.classList.add('active');
            document.querySelector(`#colorSuelaSelector button[data-color="${configuracion.colorSuela}"]`)?.classList.add('active');
            document.querySelector(`#colorCordonesSelector button[data-color="${configuracion.colorCordones}"]`)?.classList.add('active');
            document.querySelector(`#materialSelector button[data-material="${configuracion.material}"]`)?.classList.add('active');

            resumenColorBaseEl.textContent = `${configuracion.colorBase} (${configuracion.colorBase})`;
            resumenColorSuelaEl.textContent = `${configuracion.colorSuela} (${configuracion.colorSuela})`;
            resumenColorCordonesEl.textContent = `${configuracion.colorCordones} (${configuracion.colorCordones})`;
            resumenMaterialEl.textContent = configuracion.material;
        } catch (e) {
            console.error("Error initializing active buttons or summary:", e);
        }
    });

</script>

</body>
</html>